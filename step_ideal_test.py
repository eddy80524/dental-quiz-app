#!/usr/bin/env python3
"""
æ®µéšçš„ç†æƒ³å½¢LaTeXãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ†ã‚¹ãƒˆ
"""

import subprocess
import os
import uuid

def test_step_by_step_ideal():
    """æ®µéšçš„ã«ç†æƒ³å½¢ã«è¿‘ã¥ã‘ã‚‹ãƒ†ã‚¹ãƒˆ"""
    
    # ã‚¹ãƒ†ãƒƒãƒ—1: jsarticle + åŸºæœ¬çš„ãªæ ç·š
    latex_content = r"""
\documentclass[11pt,a4paper,uplatex]{jsarticle}
\usepackage[utf8]{inputenc}
\usepackage[top=30truemm,bottom=30truemm,left=25truemm,right=25truemm]{geometry}
\usepackage{amsmath,amssymb}
\usepackage{enumitem}
\usepackage{framed}
\usepackage{xcolor}
\definecolor{questionframe}{HTML}{0066CC}

\begin{document}

\title{æ­¯ç§‘å›½å®¶è©¦é¨“å•é¡Œé›†ï¼ˆæ®µéšçš„ç†æƒ³å½¢ï¼‰}
\author{Generated by Dental DX PoC}
\date{\today}
\maketitle

\begin{framed}
\textcolor{questionframe}{\textbf{å•é¡Œ 115A77}}

\textbf{ç§‘ç›®:} ã‚¯ãƒ©ã‚¦ãƒ³ãƒ–ãƒªãƒƒã‚¸å­¦

\vspace{0.5em}
\textbf{å•é¡Œ:}

40æ­³ã®å¥³æ€§ã€‚ä¸Šé¡å·¦å´æ­¯åˆ—ã®å’¬ã¿åˆã‚ã›ã®é•å’Œæ„Ÿã‚’ä¸»è¨´ã¨ã—ã¦æ¥é™¢ã—ãŸã€‚

\textbf{é¸æŠè‚¢:}
\begin{enumerate}[A.]
    \item ã‚¢
    \item ã‚¤
    \item ã‚¦
    \item ã‚¨
    \item ã‚ª
\end{enumerate}

\textbf{æ­£è§£:} C

\end{framed}

\end{document}
"""
    
    # ä¸€æ„ãªãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
    unique_id = str(uuid.uuid4())[:8]
    base_name = f"step_ideal_test_{unique_id}"
    output_dir = "/tmp"
    
    tex_file = os.path.join(output_dir, f"{base_name}.tex")
    pdf_file = os.path.join(output_dir, f"{base_name}.pdf")
    
    print(f"ğŸ“„ æ®µéšçš„ç†æƒ³å½¢ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: {tex_file}")
    
    # LaTeXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
    with open(tex_file, 'w', encoding='utf-8') as f:
        f.write(latex_content)
    
    file_size = os.path.getsize(tex_file)
    print(f"âœ… æ®µéšçš„ç†æƒ³å½¢LaTeXãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†: {file_size} ãƒã‚¤ãƒˆ")
    
    try:
        # uplatexã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
        print("ğŸ”§ uplatexï¼ˆæ®µéšçš„ç†æƒ³å½¢ï¼‰ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸­...")
        result = subprocess.run(
            ["uplatex", "-halt-on-error", "-output-directory", output_dir, os.path.basename(tex_file)],
            cwd=output_dir,
            capture_output=True,
            text=True,
            timeout=60
        )
        
        if result.returncode == 0:
            print("âœ… uplatexï¼ˆæ®µéšçš„ç†æƒ³å½¢ï¼‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸ")
            
            # DVI â†’ PDF å¤‰æ›
            dvi_file = os.path.join(output_dir, f"{base_name}.dvi")
            if os.path.exists(dvi_file):
                print("ğŸ“„ DVI â†’ PDF å¤‰æ›ä¸­...")
                dvipdf_result = subprocess.run(
                    ["dvipdfmx", "-o", f"{base_name}.pdf", f"{base_name}.dvi"],
                    cwd=output_dir,
                    capture_output=True,
                    text=True,
                    timeout=30
                )
                
                if dvipdf_result.returncode == 0 and os.path.exists(pdf_file):
                    pdf_size = os.path.getsize(pdf_file)
                    print(f"ğŸ‰ æ®µéšçš„ç†æƒ³å½¢PDFç”ŸæˆæˆåŠŸï¼ã‚µã‚¤ã‚º: {pdf_size} ãƒã‚¤ãƒˆ")
                    print(f"ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸPDF: {pdf_file}")
                    return True
                else:
                    print(f"âŒ DVI â†’ PDF å¤‰æ›å¤±æ•—: {dvipdf_result.stderr}")
                    return False
            else:
                print("âŒ DVIãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")
                return False
        else:
            print(f"âŒ uplatexï¼ˆæ®µéšçš„ç†æƒ³å½¢ï¼‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¤±æ•—:")
            print(result.stderr[:500])
            return False
            
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}")
        return False

if __name__ == "__main__":
    print("ğŸ§ª æ®µéšçš„ç†æƒ³å½¢LaTeXç’°å¢ƒãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("=" * 60)
    
    if test_step_by_step_ideal():
        print("âœ… æ®µéšçš„ç†æƒ³å½¢LaTeXç’°å¢ƒãƒ†ã‚¹ãƒˆæˆåŠŸ")
        print("ğŸ¯ framedç’°å¢ƒã‚’ä½¿ã£ãŸæ”¹è‰¯ç‰ˆPDFãŒç”Ÿæˆã§ãã¾ã™ï¼")
    else:
        print("âŒ æ®µéšçš„ç†æƒ³å½¢LaTeXç’°å¢ƒãƒ†ã‚¹ãƒˆå¤±æ•—")
